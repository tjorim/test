name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-changes:
    name: Validate PR Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Analyze changed files
        run: |
          echo "üîç Analyzing PR changes..."

          # Fetch the base branch for comparison (works on forks)
          if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "${{ github.event.pull_request.base.repo.full_name }}" ]; then
            echo "üì• Fetching PR base: ${{ github.event.pull_request.base.repo.full_name }}/${{ github.event.pull_request.base.ref }}"

            # Add the base repository as a remote and fetch from it (handles forks properly)
            BASE_REPO_URL="https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git"
            git remote add base_repo "$BASE_REPO_URL" 2>/dev/null || true
            git fetch --no-tags --depth=1 base_repo ${{ github.event.pull_request.base.ref }} || {
              echo "‚ö†Ô∏è  Failed to fetch from PR base repository, falling back to origin default branch"
              git fetch --no-tags --depth=1 origin ${{ github.event.repository.default_branch }}
            }
            CHANGED_FILES=$(git diff --name-only FETCH_HEAD...HEAD)
          else
            echo "üì• Not a PR context, comparing with default branch"
            git fetch --no-tags --depth=1 origin ${{ github.event.repository.default_branch }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD)
          fi

          echo "üìù Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/‚îú‚îÄ‚îÄ /'

          # Categorize changes
          CORE_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(html|css|scss|js|ts|tsx|jsx)$' || true)
          CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '(vite\.config\.(js|ts)|package\.json|tsconfig\.json)$' || true)
          WORKFLOW_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.github/workflows' || true)
          DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(md|txt)$' || true)
          HDAY_CHANGES=$(echo "$CHANGED_FILES" | grep -E 'lib/hday|lib/events|EventStore' || true)
          HDAY_FORMAT_CHANGES=$(echo "$CHANGED_FILES" | grep -E 'hday-format-spec\.md|hday.*\.(ts|js)' || true)

          echo ""
          echo "üìä Change Analysis:"

          if [ -n "$CORE_CHANGES" ]; then
            echo "üîß Core app changes detected"
            echo "CORE_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$CONFIG_CHANGES" ]; then
            echo "‚öôÔ∏è  Build configuration changes detected"
            echo "CONFIG_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "‚öôÔ∏è  Workflow changes detected"
            echo "WORKFLOW_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$DOC_CHANGES" ]; then
            echo "üìö Documentation changes detected"
            echo "DOC_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$HDAY_CHANGES" ]; then
            echo "üìÑ .hday parser changes detected"
            echo "HDAY_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$HDAY_FORMAT_CHANGES" ]; then
            echo "üìÑ .hday format specification changes detected"
            echo "HDAY_FORMAT_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Install dependencies
        run: npm ci

      - name: Validate core app changes
        if: env.CORE_CHANGES == 'true'
        run: |
          echo "üîß Validating core app changes..."

          # Run OXC linting
          if npm run lint; then
            echo "‚úÖ Code quality checks passed (oxlint)"
          else
            echo "‚ùå Code quality checks failed"
            exit 1
          fi

          # Run tests
          if npm run test; then
            echo "‚úÖ Tests passed (460 tests)"
          else
            echo "‚ùå Tests failed"
            exit 1
          fi

          # Check if critical shift calculation functions exist
          if [ -f "src/utils/shiftCalculations.ts" ]; then
            echo "üìã Checking critical shift functions"
            node -e "
              const fs = require('fs');
              const code = fs.readFileSync('src/utils/shiftCalculations.ts', 'utf8');

              const criticalFunctions = [
                'calculateShift',
                'getNextShift',
                'getShiftForDate'
              ];

              let missing = [];
              criticalFunctions.forEach(func => {
                const patterns = [
                  'function ' + func,
                  func + ' =',
                  'const ' + func + ' =',
                  'let ' + func + ' =',
                  'export function ' + func
                ];
                if (!patterns.some(pattern => code.includes(pattern))) {
                  missing.push(func);
                }
              });

              if (missing.length > 0) {
                console.log('‚ùå Missing critical shift functions:', missing.join(', '));
                process.exit(1);
              } else {
                console.log('‚úÖ All critical shift functions present');
              }
            "
          fi

          # Check if HTML structure is intact
          if [ -f "index.html" ]; then
            if grep -q '<html' index.html && grep -q '</html>' index.html; then
              echo "‚úÖ HTML structure intact"
            else
              echo "‚ùå HTML structure appears broken"
              exit 1
            fi
          fi

      - name: Validate .hday parser changes
        if: env.HDAY_CHANGES == 'true'
        run: |
          echo "üìÑ Validating .hday parser changes..."

          # Check if .hday parser tests still pass
          if npm run test -- hday.test.ts; then
            echo "‚úÖ .hday parser tests passed (139 tests)"
          else
            echo "‚ùå .hday parser tests failed"
            exit 1
          fi

          # Verify parser file exists
          if [ -f "src/lib/hday/parser.ts" ]; then
            echo "‚úÖ .hday parser file present"
          else
            echo "‚ùå .hday parser file missing"
            exit 1
          fi

      - name: Validate build configuration changes
        if: env.CONFIG_CHANGES == 'true'
        run: |
          echo "‚öôÔ∏è  Validating build configuration changes..."

          # Test build to ensure config is valid
          npm run build
          echo "‚úÖ Build completed successfully"

      - name: Check for version updates
        if: env.CORE_CHANGES == 'true' || env.CONFIG_CHANGES == 'true'
        run: |
          echo "üî¢ Checking version consistency..."

          # Check package.json version
          if [ -f "package.json" ]; then
            VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).version)")
            echo "‚ÑπÔ∏è  Package version: $VERSION"
          fi

      - name: Performance impact analysis
        if: env.CORE_CHANGES == 'true'
        run: |
          echo "üìä Analyzing performance impact..."

          # Build and calculate bundle size
          npm run build
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          DIST_KB=$(( (DIST_SIZE + 1023) / 1024 ))
          echo "Built bundle size: ${DIST_KB}KB"

          # Basic size check
          if [ $DIST_KB -gt 600 ]; then
            echo "‚ö†Ô∏è  Built bundle is getting large (${DIST_KB}KB)"
          else
            echo "‚úÖ Built bundle size is reasonable (${DIST_KB}KB)"
          fi

      - name: Security check
        if: env.CORE_CHANGES == 'true'
        run: |
          echo "üîí Running security checks..."

          # Check for potential security issues in source files
          SECURITY_ISSUES=""

          # Scan TypeScript/JavaScript files
          for file in $(git ls-files | grep -E '\.(ts|tsx|js|jsx)$'); do
            if [ -f "$file" ]; then
              # Check for eval usage
              if grep -E "eval\s*\(|new\s+Function\s*\(" "$file" 2>/dev/null; then
                echo "‚ö†Ô∏è  eval() or new Function() usage detected in $file - potential security risk"
                SECURITY_ISSUES="true"
              fi

              # Check for innerHTML without sanitization
              if grep -q "innerHTML.*=" "$file" 2>/dev/null; then
                echo "‚ÑπÔ∏è  innerHTML usage detected in $file - ensure content is sanitized"
              fi
            fi
          done

          if [ -z "$SECURITY_ISSUES" ]; then
            echo "‚úÖ No obvious security issues detected"
          fi

      - name: Build PR summary
        id: build-summary
        run: |
          {
            echo 'COMMENT_BODY<<EOF'
            echo "## üîç PR Validation Summary"
            echo ""
            echo "### üìù Changes Detected:"
            [ "$CORE_CHANGES" = "true" ] && echo "- üîß Core application changes"
            [ "$HDAY_CHANGES" = "true" ] && echo "- üìÑ .hday parser changes"
            [ "$HDAY_FORMAT_CHANGES" = "true" ] && echo "- üìÑ .hday format specification changes"
            [ "$CONFIG_CHANGES" = "true" ] && echo "- ‚öôÔ∏è Build configuration changes"
            [ "$WORKFLOW_CHANGES" = "true" ] && echo "- üîÑ Workflow changes"
            [ "$DOC_CHANGES" = "true" ] && echo "- üìö Documentation changes"
            echo ""
            echo "### ‚úÖ Validation Results:"
            if [ "$CORE_CHANGES" = "true" ]; then
              echo "- ‚úÖ Code quality checks passed (OXC)"
              echo "- ‚úÖ Tests passed (Vitest)"
              echo "- ‚úÖ Critical shift functions verified"
            fi
            if [ "$HDAY_CHANGES" = "true" ]; then
              echo "- ‚úÖ .hday parser tests passed (139 tests)"
            fi
            if [ "$CONFIG_CHANGES" = "true" ]; then
              echo "- ‚úÖ Build configuration validated"
            fi
            if [ "$CORE_CHANGES" = "true" ]; then
              echo "- ‚úÖ Security scan completed"
              echo "- ‚úÖ Performance impact analyzed"
            fi
            echo ""
            echo "### üöÄ Ready for Review"
            if [ "$CORE_CHANGES" = "true" ] || [ "$CONFIG_CHANGES" = "true" ]; then
              echo "All automated checks passed! This PR is ready for manual review."
            else
              echo "No code changes detected. This PR primarily contains documentation or workflow updates and is ready for manual review."
            fi
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Comment PR with summary
        uses: ./.github/actions/upsert-comment
        with:
          comment-identifier: 'üîç PR Validation Summary'
          comment-body: ${{ env.COMMENT_BODY }}
