name: Worktime CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-build:
    name: Validate Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate TypeScript
        run: |
          echo "Validating TypeScript and React files..."
          npx tsc --noEmit
          echo "‚úÖ TypeScript is valid"

      - name: Run code quality checks
        run: |
          echo "Running OXC linting and tests..."
          npm run lint
          npm run test
          echo "‚úÖ All quality checks passed"

      - name: Build application
        run: |
          echo "Building Worktime with Vite 8..."
          npm run build

          echo "Checking built application..."
          # Core source files (Vite structure)
          [ -f "index.html" ] && echo "‚úÖ index.html found" || { echo "‚ùå index.html missing"; exit 1; }
          [ -f "src/styles/main.scss" ] && echo "‚úÖ src/styles/main.scss found" || { echo "‚ùå src/styles/main.scss missing"; exit 1; }
          [ -f "src/App.tsx" ] && echo "‚úÖ src/App.tsx found" || { echo "‚ùå src/App.tsx missing"; exit 1; }

          # Built files
          [ -f "dist/index.html" ] && echo "‚úÖ Built index.html found" || { echo "‚ùå Built index.html missing"; exit 1; }

          # Check for built CSS (Vite generates hashed filenames in subdirectories)
          if ls dist/assets/css/*.css 1> /dev/null 2>&1; then
            echo "‚úÖ Built CSS files found"
          else
            echo "‚ùå Built CSS files missing"
            exit 1
          fi

          # Check for built JS (Vite generates hashed filenames in subdirectories)
          if ls dist/assets/js/*.js 1> /dev/null 2>&1; then
            echo "‚úÖ Built JS files found"
          else
            echo "‚ùå Built JS files missing"
            exit 1
          fi

          # Application assets
          [ -f "public/assets/icons/icon-192.png" ] && echo "‚úÖ 192px icon found" || { echo "‚ùå 192px icon missing"; exit 1; }
          [ -f "public/assets/icons/icon-512.png" ] && echo "‚úÖ 512px icon found" || { echo "‚ùå 512px icon missing"; exit 1; }

          echo "‚úÖ All build requirements met"

      - name: Calculate bundle size
        env:
          MAX_BUNDLE_SIZE_KB: ${{ vars.MAX_BUNDLE_SIZE_KB || '600' }}
        run: |
          echo "Calculating built bundle size..."

          # Calculate built bundle size
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          ICONS_SIZE=$(du -sb public/assets/icons/ | cut -f1)
          TOTAL_SIZE=$((DIST_SIZE + ICONS_SIZE))
          TOTAL_KB=$(( (TOTAL_SIZE + 1023) / 1024 ))

          echo "üìä Bundle Size Analysis:"
          echo "‚îú‚îÄ‚îÄ Built assets: $(( (DIST_SIZE + 1023) / 1024 ))KB"
          echo "‚îú‚îÄ‚îÄ Icons: $(( (ICONS_SIZE + 1023) / 1024 ))KB"
          echo "‚îî‚îÄ‚îÄ Total: ${TOTAL_KB}KB"

          # List built files for transparency
          echo ""
          echo "üìÅ Built files:"
          find dist -type f -exec ls -lh {} \; | awk '{print "‚îú‚îÄ‚îÄ " $9 ": " $5}'

          # Bundle size check (warn if over threshold)
          if [ $TOTAL_KB -gt $MAX_BUNDLE_SIZE_KB ]; then
            echo "‚ö†Ô∏è  Bundle size is large (${TOTAL_KB}KB > ${MAX_BUNDLE_SIZE_KB}KB)"
          else
            echo "‚úÖ Bundle size is optimal (${TOTAL_KB}KB <= ${MAX_BUNDLE_SIZE_KB}KB)"
          fi

          # Save for PR comment
          echo "BUNDLE_SIZE=${TOTAL_KB}KB" >> $GITHUB_ENV

      - name: Validate shift tracking
        run: |
          echo "Validating shift tracking features..."
          [ -f "src/utils/shiftCalculations.ts" ] && echo "‚úÖ Shift calculations utility found" || { echo "‚ùå Shift calculations missing"; exit 1; }
          [ -f "src/hooks/useShiftCalculation.ts" ] && echo "‚úÖ Shift calculation hook found" || { echo "‚ùå Shift calculation hook missing"; exit 1; }
          [ -f "src/components/WelcomeWizard.tsx" ] && echo "‚úÖ WelcomeWizard component found" || { echo "‚ùå WelcomeWizard component missing"; exit 1; }
          echo "‚úÖ Shift tracking features validated"

      - name: Validate .hday parser
        run: |
          echo "Validating .hday file parser..."
          # Check parser module
          [ -f "src/lib/hday/parser.ts" ] && echo "‚úÖ Parser module found" || { echo "‚ùå Parser missing"; exit 1; }
          [ -f "tests/lib/hday.test.ts" ] && echo "‚úÖ Parser tests found (139 tests)" || { echo "‚ùå Parser tests missing"; exit 1; }

          # Check event converters
          [ -f "src/lib/events/converters.ts" ] && echo "‚úÖ Event converters found" || { echo "‚ùå Event converters missing"; exit 1; }
          [ -f "tests/lib/events/converters.test.ts" ] && echo "‚úÖ Converter tests found" || { echo "‚ùå Converter tests missing"; exit 1; }

          # Check EventStore
          [ -f "src/contexts/EventStoreContext.tsx" ] && echo "‚úÖ EventStoreContext found" || { echo "‚ùå EventStoreContext missing"; exit 1; }
          [ -f "tests/contexts/EventStoreContext.test.tsx" ] && echo "‚úÖ EventStore tests found" || { echo "‚ùå EventStore tests missing"; exit 1; }

          # Check UI components
          [ -f "src/components/TimeOffView.tsx" ] && echo "‚úÖ TimeOffView component found" || { echo "‚ùå TimeOffView component missing"; exit 1; }
          [ -f "src/components/EventModal.tsx" ] && echo "‚úÖ EventModal component found" || { echo "‚ùå EventModal component missing"; exit 1; }

          echo "‚úÖ .hday parser and time-off management validated"

      - name: Build comment body
        if: github.event_name == 'pull_request'
        id: build-comment
        run: |
          {
            echo 'COMMENT_BODY<<EOF'
            echo "## üöÄ Build Validation Results"
            echo ""
            echo "‚úÖ All build requirements met"
            echo "‚úÖ Code quality checks passed (OXC)"
            echo "‚úÖ Tests passed (Vitest - 460 tests)"
            echo "‚úÖ Build successful (Vite 8)"
            echo "‚úÖ Core shift tracking present"
            echo "‚úÖ Time-off management (.hday) present"
            echo ""
            echo "üìä **Bundle Size:** ${BUNDLE_SIZE}"
            echo ""
            echo "Ready for deployment! üéâ"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/upsert-comment
        with:
          comment-identifier: 'üöÄ Build Validation Results'
          comment-body: ${{ env.COMMENT_BODY }}
